<!doctype html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.7/dist/umd/supabase.min.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Annual Pass Transactions - Mundiyar Toll (Report)</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; }
    .container { max-width: 1200px; margin: 0 auto; }
    .page-title { color:#333; text-align:center; margin: 0 0 16px 0; }
    h3{ margin-top:28px; }
    .card{ background:#fff;border:1px solid #ddd;border-radius:10px;padding:14px;
           box-shadow:2px 2px 6px rgba(0,0,0,.08); margin-bottom:16px;}
    label{ display:block; margin:8px 0 6px; color:#444;}
    input,button,select{ padding:8px 10px; border-radius:8px; border:1px solid #aaa; }
    button{ background:#007bff; color:#fff; border:none; cursor:pointer; }
    button:hover{ background:#0056b3; }
    table{ width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; }
    th,td{ padding:10px; border:1px solid #e2e2e2; text-align:left; }
    th{ background:#007bff; color:#fff; }
    tr:nth-child(even){ background:#f9f9f9; }
    .summary { display:flex; flex-wrap:wrap; gap:12px; }
    .box{ border:1px solid #ccc; border-radius:10px; padding:12px; min-width:220px; background:#fff; flex:1; }
    .muted{ color:#666; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    #loginBox {max-width:400px;margin:80px auto;padding:20px;border:1px solid #ccc;
               border-radius:10px;background:#fff;box-shadow:2px 2px 8px rgba(0,0,0,0.1);}
    #loginBox h2 {text-align:center;margin-bottom:20px;}
    #loginError {color:#b30000;text-align:center;margin-top:10px;display:none;}

    #dailyWrap table th:first-child,
    #dailyWrap table td:first-child {
      width: 420px;
      min-width: 380px;
      white-space: nowrap;
    }
  </style>
</head>
<body>

<!-- Login -->
<div id="loginBox">
  <h2>Mundiyar Toll - Login</h2>
  <label>Username:</label>
  <input type="text" id="usernameInput" style="width:100%;">
  <label>Password:</label>
  <input type="password" id="passwordInput" style="width:100%;">
  <button onclick="checkLogin()" style="width:100%;">Login</button>
  <p id="loginError">Invalid username or password.</p>
</div>

<!-- App -->
<div id="app" style="display:none">
  <div class="container">
    <h2 class="page-title">Annual Pass Transactions - Mundiyar Toll</h2>

    <div style="margin:20px 0; text-align:center;">
      <button id="btnUpload">Upload</button>
    </div>

    <div class="card">
      <h3>Build Report (08:00 → 07:59)</h3>
      <form id="filterForm" class="row">
        <div><label>From Date</label> <input type="date" id="fromDate" required /></div>
        <div><label>To Date</label> <input type="date" id="toDate" required /></div>
        <div style="align-self:flex-end"><button type="submit">Filter</button></div>
        <div style="align-self:flex-end"><button id="btnRefresh" type="button">Refresh</button></div>
      </form>
      <div class="row" style="margin-top:6px">
        <span class="muted">Filtered = transaction_amount = 15. <b>3rd+ txn per calendar day → Omitted</b>.</span>
      </div>
    </div>

    <div id="summaryWrap" class="card" style="display:none">
      <div class="summary">
        <div class="box"><div class="muted">Period</div><div id="sum_period">—</div></div>
        <div class="box"><div class="muted">Single Journeys</div><div id="sum_total_single">0</div></div>
        <div class="box"><div class="muted">Single Fare</div><div id="sum_single_fare">110</div></div>
        <div class="box"><div class="muted">Return Journeys</div><div id="sum_total_return">0</div></div>
        <div class="box"><div class="muted">Return Fare</div><div id="sum_return_fare">55</div></div>
        <div class="box"><div class="muted">Total Compensation</div><div id="sum_total_comp">0</div></div>
        <div class="box"><div class="muted">Omitted</div><div id="sum_omitted">0</div></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnExportExcel" style="background:#28a745">Export Report CSVs</button>
        <button id="btnExportAll" style="background:#17a2b8">Export ALL Data</button>
        <button id="btnPrint" style="background:#6c757d">Print / PDF</button>
        <span id="rowCount" class="muted"></span>
      </div>
    </div>

    <div id="dailyWrap" class="card" style="display:none">
      <h3>Daily Summary</h3>
      <table id="dailyTable">
        <thead><tr>
          <th>Period</th><th>Total Txn</th><th>Qualified</th>
          <th>Single</th><th>Return</th><th>Compensation</th><th>Omitted</th>
        </tr></thead>
        <tbody id="dailyTbody"></tbody>
      </table>
    </div>

    <div id="keptWrap" class="card" style="display:none">
      <h3>Qualified Transactions</h3>
      <table id="keptTable">
        <thead><tr>
          <th>Date & Time</th><th>Vehicle</th><th>Type</th><th>Amount</th><th>Journey</th>
        </tr></thead>
        <tbody id="keptTbody"></tbody>
      </table>
    </div>

    <div id="omitWrap" class="card" style="display:none">
      <h3>Omitted Transactions</h3>
      <table id="omitTable">
        <thead><tr>
          <th>Date & Time</th><th>Vehicle</th><th>Type</th><th>Amount</th><th>Txn No</th>
        </tr></thead>
        <tbody id="omitTbody"></tbody>
      </table>
    </div>

  </div>
</div>

<script>
/* ================= Utilities ================= */
const rupee = n => '₹' + Number(n||0).toLocaleString('en-IN');
const ymd = d => new Date(d).toISOString().slice(0,10);

// Operational Window
function opDayKey(ts){
  const d = new Date(ts);
  d.setHours(d.getHours() - 8);
  d.setHours(0,0,0,0);
  return ymd(d);
}
function opDayWindowFor(dateYmd){
  const d = new Date(dateYmd+"T00:00:00");
  const start = new Date(d); start.setHours(8,0,0,0);
  const end = new Date(d); end.setDate(end.getDate()+1); end.setHours(7,59,59,999);
  return { start, end };
}
function calendarDayKey(ts){
  const d=new Date(ts); d.setHours(0,0,0,0); return ymd(d);
}

/* ================= Supabase ================= */
const SUPABASE_URL="https://pxcbdrkhhoqqhocmrtgj.supabase.co";
const SUPABASE_ANON_KEY="YOUR_PUBLIC_KEY";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Fetch Window */
async function fetchAllPassTxns(startISO,endISO){
  let data=[];
  let from=0,page=1000,count=null;
  while(true){
    const res=await db.from("pass_transactions")
      .select("vehicle_registration_number, mapper_vehicle_class, reader_read_time, transaction_amount, cch_transaction_id, journey_type",{count:"exact"})
      .eq("transaction_amount",15)
      .gte("reader_read_time",startISO)
      .lte("reader_read_time",endISO)
      .order("reader_read_time",{ascending:true})
      .range(from,from+page-1);
    if(res.error) throw res.error;
    if(count===null) count=res.count;
    data=data.concat(res.data||[]);
    if(!res.data || res.data.length < page) break;
    from+=page;
  }
  return {rows:data,count:count};
}

/* Main Submit */
document.getElementById("filterForm").addEventListener("submit",async e=>{
  e.preventDefault();
  const from=document.getElementById("fromDate").value;
  const to=document.getElementById("toDate").value;
  const {start:globalStart,end:globalEnd}=opDayWindowFor(from);

  const {rows:inRows,count}=await fetchAllPassTxns(globalStart.toISOString(),globalEnd.toISOString());
  if(!inRows.length){alert("No records found"); return;}

  const vrnSet=new Set(inRows.map(r=>r.vehicle_registration_number.toUpperCase()));
  const allHistory=[...inRows];
  allHistory.sort((a,b)=>new Date(a.reader_read_time)-new Date(b.reader_read_time));

  const byOp=new Map();
  const countsByDay=new Map();
  const kept=[],omitted=[];

  for(const r of allHistory){
    const ts=new Date(r.reader_read_time);
    const vrn=r.vehicle_registration_number.toUpperCase();
    const opKey=opDayKey(ts);
    const calKey=calendarDayKey(ts);

    if(!countsByDay.has(vrn)) countsByDay.set(vrn,new Map());
    const dMap=countsByDay.get(vrn);
    const prev=dMap.get(calKey)||0;
    const now=prev+1;
    dMap.set(calKey,now);

    const op=byOp.get(opKey)||{tot:0,qual:0,sing:0,ret:0,omit:0};
    if(ts>=globalStart && ts<=globalEnd) op.tot++;

    if(now>2){
      if(ts>=globalStart && ts<=globalEnd){
        op.omit++;
        omitted.push({r,now});
      }
    } else {
      if(ts>=globalStart && ts<=globalEnd){
        op.qual++;
        if(/single/i.test(r.journey_type)) op.sing++;
        else if(/return/i.test(r.journey_type)) op.ret++;
        kept.push(r);
      }
    }

    byOp.set(opKey,op);
  }

  const SINGLE_FARE=110,RETURN_FARE=55;
  const labels=[]; let d=new Date(from); const end=new Date(to);
  while(d<=end){labels.push(ymd(d)); d.setDate(d.getDate()+1);}

  const daily=[];
  for(const k of labels){
    const o=byOp.get(k)||{tot:0,qual:0,sing:0,ret:0,omit:0};
    daily.push({
      period:k,
      tot:o.tot,
      qual:o.qual,
      sing:o.sing,
      ret:o.ret,
      comp:o.sing*SINGLE_FARE+o.ret*RETURN_FARE,
      omit:o.omit
    });
  }

  const totRow = daily.reduce((a,b)=>({
    tot:a.tot+b.tot,
    qual:a.qual+b.qual,
    sing:a.sing+b.sing,
    ret:a.ret+b.ret,
    comp:a.comp+b.comp,
    omit:a.omit+b.omit
  }),{tot:0,qual:0,sing:0,ret:0,comp:0,omit:0});

  document.getElementById("sum_period").textContent=`${from} → ${to}`;
  document.getElementById("sum_total_single").textContent=totRow.sing;
  document.getElementById("sum_total_return").textContent=totRow.ret;
  document.getElementById("sum_total_comp").textContent=rupee(totRow.comp);
  document.getElementById("sum_omitted").textContent=totRow.omit;

  document.getElementById("summaryWrap").style.display="block";
  document.getElementById("dailyWrap").style.display="block";
  document.getElementById("keptWrap").style.display="block";
  document.getElementById("omitWrap").style.display="block";

  document.getElementById("rowCount").textContent = `Rows: ${count}`;

  document.getElementById("dailyTbody").innerHTML=daily.map(r=>`
    <tr><td>${r.period}</td><td>${r.tot}</td><td>${r.qual}</td><td>${r.sing}</td><td>${r.ret}</td><td>${rupee(r.comp)}</td><td>${r.omit}</td></tr>`
  ).join("");

  document.getElementById("keptTbody").innerHTML=kept.map(r=>`
    <tr><td>${new Date(r.reader_read_time).toLocaleString()}</td><td>${r.vehicle_registration_number}</td><td>${r.mapper_vehicle_class}</td><td>${r.transaction_amount}</td><td>${r.journey_type}</td></tr>`
  ).join("");

  document.getElementById("omitTbody").innerHTML=omitted.map(o=>`
    <tr><td>${new Date(o.r.reader_read_time).toLocaleString()}</td><td>${o.r.vehicle_registration_number}</td><td>${o.r.mapper_vehicle_class}</td><td>${o.r.transaction_amount}</td><td>${o.now}</td></tr>`
  ).join("");

});

/* Export ALL Data */
document.getElementById("btnExportAll").onclick=()=>{ window.open("?exportAll=1"); };

/* Export CSV Report */
document.getElementById("btnExportExcel").onclick=()=>{ alert("CSV Export will be added here"); };

/* Print */
document.getElementById("btnPrint").onclick=()=>{ window.print(); };

/* Refresh */
document.getElementById("btnRefresh").onclick=()=> {
  document.getElementById("filterForm").dispatchEvent(new Event("submit"));
};

/* Login */
function checkLogin(){
  const u=document.getElementById("usernameInput").value.trim();
  const p=document.getElementById("passwordInput").value;
  const users={"admin":"9540595577","manager":"abcd","Likhar":"8888416918","Kishor":"998704077"};
  if(users[u]===p){
    loginBox.style.display="none";
    app.style.display="block";
  } else loginError.style.display="block";
}

/* Upload Redirect */
document.getElementById("btnUpload").onclick = ()=> window.location="Upload.html";
</script>

</body>
</html>
