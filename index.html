<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Annual Pass Transactions (Supabase + CSV Upload)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; }
    h2 { color:#333; } h3{ margin-top:28px; }
    .card{ background:#fff;border:1px solid #ddd;border-radius:10px;padding:14px;box-shadow:2px 2px 6px rgba(0,0,0,.08); margin-bottom:16px;}
    label{ display:block; margin:8px 0 6px; color:#444;}
    input,button,select{ padding:8px 10px; border-radius:8px; border:1px solid #aaa; }
    button{ background:#007bff; color:#fff; border:none; cursor:pointer; }
    button:hover{ background:#0056b3; }
    table{ width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; }
    th,td{ padding:10px; border:1px solid #e2e2e2; text-align:left; }
    th{ background:#007bff; color:#fff; }
    tr:nth-child(even){ background:#f9f9f9; }
    .summary { display:flex; flex-wrap:wrap; gap:12px; }
    .box{ border:1px solid #ccc; border-radius:10px; padding:12px; min-width:220px; background:#fff; flex:1; }
    .muted{ color:#666; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .success{ color:#1e7e34; font-weight:600; }
    .warn{ color:#b36b00; font-weight:600; }
    .bad{ color:#b30000; font-weight:600; }
  </style>
</head>
<body>
  <h2>Annual Pass Transactions â€” Supabase (Free) + CSV Upload</h2>

  <!-- CSV UPLOAD -->
  <div class="card">
    <h3>Upload CSV â†’ Insert rows into <code>pass_transactions</code></h3>
    <p class="muted">
      The uploader accepts your CSV with these headers (any order is fine):<br/>
      <em>
      Entry Plaza ID, Entry Lane ID, Exit Plaza ID, Exit Lane ID, Tag ID,
      Vehicle Registration Number, Plaza Transaction ID, CCH Transaction ID, AVC Class, Mapper Vehicle Class,
      Reader Read Time, Transaction Received Time, Transaction Processed Time, Transaction Amount, Accepted Amount,
      Transaction Status, Reason Code, Fare Type, Chargeback Raised?, Chargeback Amount Accepted, Chargeback Settlement Date,
      Adjustment Raised, Adjustment Amount Accepted, Adjustment Settlement Date, Remarks
      </em>
    </p>
    <div class="row">
      <input type="file" id="csvFile" accept=".csv" />
      <select id="csvDelimiter">
        <option value=",">Comma</option>
        <option value=";">Semicolon</option>
        <option value="\t">Tab</option>
      </select>
      <button id="btnUpload">Parse & Upload</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span id="uploadInfo" class="muted"></span>
    </div>
  </div>

  <!-- REPORT FILTER -->
  <div class="card">
    <h3>Build Report (08:00 â†’ next day 07:59)</h3>
    <form id="filterForm" class="row">
      <div>
        <label>From Date</label>
        <input type="date" id="fromDate" required />
      </div>
      <div>
        <label>To Date</label>
        <input type="date" id="toDate" required />
      </div>
      <div style="align-self:flex-end">
        <button type="submit">Filter</button>
      </div>
      <div style="align-self:flex-end">
        <button id="btnRefresh" type="button">Refresh</button>
      </div>
    </form>
    <div class="row" style="margin-top:6px">
      <span class="muted">Only transactions with <strong>Transaction Amount = 15</strong> are considered for compensation logic.</span>
    </div>
  </div>

  <!-- SUMMARY -->
  <div id="summaryWrap" class="card" style="display:none">
    <div class="summary">
      <div class="box"><div class="muted">Period</div><div id="sum_period" style="font-weight:700">â€”</div></div>
      <div class="box"><div class="muted">Total Single Journeys</div><div id="sum_total_single" style="font-weight:700">0</div></div>
      <div class="box"><div class="muted">Single Fare (B)</div><div id="sum_single_fare" style="font-weight:700">110</div></div>
      <div class="box"><div class="muted">Total Return Journeys</div><div id="sum_total_return" style="font-weight:700">0</div></div>
      <div class="box"><div class="muted">Return Fare (D)</div><div id="sum_return_fare" style="font-weight:700">55</div></div>
      <div class="box"><div class="muted">Total Compensation</div><div id="sum_total_comp" style="font-weight:700">0</div></div>
      <div class="box"><div class="muted">Omitted Transactions (3rd+)</div><div id="sum_omitted" style="font-weight:700">0</div></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnExportExcel" style="background:#28a745">Export to Excel</button>
      <button id="btnPrint" style="background:#6c757d">Export to PDF (Print)</button>
      <span id="rowCount" class="muted" style="margin-left:10px"></span>
    </div>
  </div>

  <!-- DAILY -->
  <div id="dailyWrap" class="card" style="display:none">
    <h3>Daily Summary</h3>
    <table>
      <thead>
        <tr>
          <th>Period</th>
          <th>Total Annual Pass Transactions</th>
          <th>Total Qualified Transactions</th>
          <th>Total Single Journeys</th>
          <th>Total Return Journeys</th>
          <th>Total Compensation</th>
          <th>Omitted Transactions</th>
        </tr>
      </thead>
      <tbody id="dailyTbody"></tbody>
      <tfoot>
        <tr style="background:#ffc107;font-weight:700">
          <td id="tot_period">TOTAL</td>
          <td id="tot_total_txn">0</td>
          <td id="tot_qualified_txn">0</td>
          <td id="tot_total_single">0</td>
          <td id="tot_total_return">0</td>
          <td id="tot_compensation">0</td>
          <td id="tot_omitted">0</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- KEPT -->
  <div id="keptWrap" class="card" style="display:none">
    <h3>Kept Transactions (First 2 per Vehicle per Op-Day)</h3>
    <table>
      <thead>
        <tr>
          <th>Date & Time</th>
          <th>Vehicle No</th>
          <th>Vehicle Type</th>
          <th>Amount</th>
          <th>Journey Type</th>
        </tr>
      </thead>
      <tbody id="keptTbody"></tbody>
    </table>
  </div>

  <!-- OMITTED -->
  <div id="omitWrap" class="card" style="display:none">
    <h3>Omitted Transactions (3rd and after)</h3>
    <table>
      <thead>
        <tr>
          <th>Date & Time</th>
          <th>Vehicle No</th>
          <th>Vehicle Type</th>
          <th>Amount</th>
          <th>Txn No</th>
        </tr>
      </thead>
      <tbody id="omitTbody"></tbody>
    </table>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <script>
    // ðŸ”— Supabase credentials (auto-connect)
    const SUPABASE_URL = "https://pxcbdrkhhoqqhocmrtgj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4Y2JkcmtoaG9xcWhvY21ydGdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NjIxMDcsImV4cCI6MjA3MjUzODEwN30.ufOrUdyi307pqmZdH5AS56UGmMti8n_2BW8YHK-2rk4";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // âœ… CSV header mapping (same as before, omitted here for brevity) ...
    const HEADER_MAP = {
      "Entry Plaza ID": "entry_plaza_id",
      "Entry Lane ID": "entry_lane_id",
      "Exit Plaza ID": "exit_plaza_id",
      "Exit Lane ID": "exit_lane_id",
      "Tag ID": "tag_id",
      "Vehicle Registration Number": "vehicle_registration_number",
      "Plaza Transaction ID": "plaza_transaction_id",
      "CCH Transaction ID": "cch_transaction_id",
      "AVC Class": "avc_class",
      "Mapper Vehicle Class": "mapper_vehicle_class",
      "Reader Read Time": "reader_read_time",
      "Transaction Received Time": "transaction_received_time",
      "Transaction Processed Time": "transaction_processed_time",
      "Transaction Amount": "transaction_amount",
      "Accepted Amount": "accepted_amount",
      "Transaction Status": "transaction_status",
      "Reason Code": "reason_code",
      "Fare Type": "fare_type",
      "Chargeback Raised?": "chargeback_raised",
      "Chargeback Amount Accepted": "chargeback_amount_accepted",
      "Chargeback Settlement Date": "chargeback_settlement_date",
      "Adjustment Raised": "adjustment_raised",
      "Adjustment Amount Accepted": "adjustment_amount_accepted",
      "Adjustment Settlement Date": "adjustment_settlement_date",
      "Remarks": "remarks"
    };

    // ðŸŸ¢ CSV upload with UPSERT on CCH Transaction ID
    document.getElementById('btnUpload').onclick = async () => {
      const f = document.getElementById('csvFile').files[0];
      if(!f){ alert('Choose a CSV file'); return; }
      const delimiter = document.getElementById('csvDelimiter').value;

      document.getElementById('uploadInfo').textContent = 'Parsing CSV...';
      Papa.parse(f, {
        header: true,
        skipEmptyLines: true,
        delimiter: delimiter === '\\t' ? '\t' : delimiter,
        complete: async (res) => {
          const rows = res.data;
          if(!rows.length){ document.getElementById('uploadInfo').textContent='No rows found.'; return; }

          const mapped = rows.map(r => {
            const obj = {};
            for(const [csvKey, dbKey] of Object.entries(HEADER_MAP)){
              obj[dbKey] = r[csvKey] ?? null;
            }
            return obj;
          });

          const chunk = 500;
          let ok = 0, err = 0;
          for(let i=0;i<mapped.length;i+=chunk){
            const part = mapped.slice(i,i+chunk);
            const { error } = await supabase
              .from('pass_transactions')
              .upsert(part, { onConflict: ['cch_transaction_id'] }); // âœ… prevents duplicates
            if(error){ console.error(error); err += part.length; }
            else { ok += part.length; }
            document.getElementById('uploadInfo').textContent = `Uploaded ${ok}/${mapped.length}. Errors: ${err}.`;
          }
        }
      });
    };

    // âš¡ Report + Export logic stays same as before
    // (use your existing functions for summaries, daily totals, kept/omitted, etc.)
  </script>
</body>
</html>
