<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Annual Pass Transactions - Mundiyar Toll</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Center whole page content */
    .container { max-width: 1200px; margin: 0 auto; }

    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; }
    /* Center the main page title */
    .page-title { color:#333; text-align:center; margin: 0 0 16px 0; }

    h3{ margin-top:28px; }
    .card{ background:#fff;border:1px solid #ddd;border-radius:10px;padding:14px;box-shadow:2px 2px 6px rgba(0,0,0,.08); margin-bottom:16px;}
    label{ display:block; margin:8px 0 6px; color:#444;}
    input,button,select{ padding:8px 10px; border-radius:8px; border:1px solid #aaa; }
    button{ background:#007bff; color:#fff; border:none; cursor:pointer; }
    button:hover{ background:#0056b3; }
    table{ width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; }
    th,td{ padding:10px; border:1px solid #e2e2e2; text-align:left; }
    th{ background:#007bff; color:#fff; }
    tr:nth-child(even){ background:#f9f9f9; }
    .summary { display:flex; flex-wrap:wrap; gap:12px; }
    .box{ border:1px solid #ccc; border-radius:10px; padding:12px; min-width:220px; background:#fff; flex:1; }
    .muted{ color:#666; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .success{ color:#1e7e34; font-weight:600; }
    .warn{ color:#b36b00; font-weight:600; }
    .bad{ color:#b30000; font-weight:600; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    /* Widen the first column ("Period") in Daily Summary */
    #dailyWrap table th:first-child,
    #dailyWrap table td:first-child {
      width: 420px;
      min-width: 380px;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="page-title">Annual Pass Transactions - Mundiyar Toll</h2>

    <!-- CSV UPLOAD -->
    <div class="card">
      <h3>Upload CSV â†’ <code>pass_transactions</code></h3>
      <div class="row">
        <input type="file" id="csvFile" accept=".csv" />
        <select id="csvDelimiter" title="Choose delimiter">
          <option value=",">Comma</option>
          <option value=";">Semicolon</option>
          <option value="\t">Tab</option>
        </select>
        <button id="btnUpload">Parse & Upload</button>
      </div>
      <div class="row" style="margin-top:8px">
        <span id="uploadInfo" class="muted"></span>
      </div>
      <pre id="errorBox" class="mono" style="white-space:pre-wrap;color:#b30000;margin-top:8px;"></pre>
    </div>

    <!-- REPORT FILTER -->
    <div class="card">
      <h3>Build Report (08:00 â†’ 07:59)</h3>
      <form id="filterForm" class="row">
        <div>
          <label>From Date</label>
          <input type="date" id="fromDate" required />
        </div>
        <div>
          <label>To Date</label>
          <input type="date" id="toDate" required />
        </div>
        <div style="align-self:flex-end">
          <button type="submit">Filter</button>
        </div>
        <div style="align-self:flex-end">
          <button id="btnRefresh" type="button">Refresh</button>
        </div>
      </form>
      <div class="row" style="margin-top:6px">
        <span class="muted">Only transactions with <strong>Transaction Amount = 15</strong> are considered for compensation logic.</span>
      </div>
    </div>

    <!-- SUMMARY -->
    <div id="summaryWrap" class="card" style="display:none">
      <div class="summary">
        <div class="box"><div class="muted">Period</div><div id="sum_period" style="font-weight:700">â€”</div></div>
        <div class="box"><div class="muted">Total Single Journeys</div><div id="sum_total_single" style="font-weight:700">0</div></div>
        <div class="box"><div class="muted">Single Fare (B)</div><div id="sum_single_fare" style="font-weight:700">110</div></div>
        <div class="box"><div class="muted">Total Return Journeys</div><div id="sum_total_return" style="font-weight:700">0</div></div>
        <div class="box"><div class="muted">Return Fare (D)</div><div id="sum_return_fare" style="font-weight:700">55</div></div>
        <div class="box"><div class="muted">Total Compensation</div><div id="sum_total_comp" style="font-weight:700">0</div></div>
        <div class="box"><div class="muted">Omitted Transactions (3rd+)</div><div id="sum_omitted" style="font-weight:700">0</div></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnExportExcel" style="background:#28a745">Export to Excel</button>
        <button id="btnPrint" style="background:#6c757d">Export to PDF (Print)</button>
        <span id="rowCount" class="muted" style="margin-left:10px"></span>
      </div>
    </div>

    <!-- DAILY -->
    <div id="dailyWrap" class="card" style="display:none">
      <h3>Daily Summary</h3>
      <table>
        <thead>
          <tr>
            <th>Period</th>
            <th>Total Annual Pass Transactions</th>
            <th>Total Qualified Transactions</th>
            <th>Total Single Journeys</th>
            <th>Total Return Journeys</th>
            <th>Total Compensation</th>
            <th>Omitted Transactions</th>
          </tr>
        </thead>
        <tbody id="dailyTbody"></tbody>
        <tfoot>
          <tr style="background:#ffc107;font-weight:700">
            <td id="tot_period">TOTAL</td>
            <td id="tot_total_txn">0</td>
            <td id="tot_qualified_txn">0</td>
            <td id="tot_total_single">0</td>
            <td id="tot_total_return">0</td>
            <td id="tot_compensation">0</td>
            <td id="tot_omitted">0</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- KEPT -->
    <div id="keptWrap" class="card" style="display:none">
      <h3>Transactions (First 2 per Vehicle in 24hr.)</h3>
      <table>
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Vehicle No</th>
            <th>Vehicle Type</th>
            <th>Amount</th>
            <th>Journey Type</th>
          </tr>
        </thead>
        <tbody id="keptTbody"></tbody>
      </table>
    </div>

    <!-- OMITTED -->
    <div id="omitWrap" class="card" style="display:none">
      <h3>Omitted Transactions (3rd and after)</h3>
      <table>
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Vehicle No</th>
            <th>Vehicle Type</th>
            <th>Amount</th>
            <th>Txn No</th>
          </tr>
        </thead>
        <tbody id="omitTbody"></tbody>
      </table>
    </div>

    <!-- libs -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

    <script>
      // ðŸ”— Supabase credentials (auto-connect)
      const SUPABASE_URL = "https://pxcbdrkhhoqqhocmrtgj.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4Y2JkcmtoaG9xcWhvY21ydGdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NjIxMDcsImV4cCI6MjA3MjUzODEwN30.ufOrUdyi307pqmZdH5AS56UGmMti8n_2BW8YHK-2rk4";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // fares
      const SINGLE_FARE = 110.0;
      const RETURN_FARE = 55.0;

      // CSV -> DB column map
      const HEADER_MAP = {
        "Entry Plaza ID": "entry_plaza_id",
        "Entry Lane ID": "entry_lane_id",
        "Exit Plaza ID": "exit_plaza_id",
        "Exit Lane ID": "exit_lane_id",
        "Tag ID": "tag_id",
        "Vehicle Registration Number": "vehicle_registration_number",
        "Plaza Transaction ID": "plaza_transaction_id",
        "CCH Transaction ID": "cch_transaction_id",
        "AVC Class": "avc_class",
        "Mapper Vehicle Class": "mapper_vehicle_class",
        "Reader Read Time": "reader_read_time",
        "Transaction Received Time": "transaction_received_time",
        "Transaction Processed Time": "transaction_processed_time",
        "Transaction Amount": "transaction_amount",
        "Accepted Amount": "accepted_amount",
        "Transaction Status": "transaction_status",
        "Reason Code": "reason_code",
        "Fare Type": "fare_type",
        "Chargeback Raised?": "chargeback_raised",
        "Chargeback Amount Accepted": "chargeback_amount_accepted",
        "Chargeback Settlement Date": "chargeback_settlement_date",
        "Adjustment Raised": "adjustment_raised",
        "Adjustment Amount Accepted": "adjustment_amount_accepted",
        "Adjustment Settlement Date": "adjustment_settlement_date",
        "Remarks": "remarks"
      };

      // helpers
      const rupee = n => 'â‚¹' + Number(n||0).toLocaleString('en-IN', { maximumFractionDigits: 2 });

      // Local-only YYYY-MM-DD (no UTC conversion)
      const ymd = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      };

      function toISO(s){
        if (s == null || s === "") return null;
        const str = String(s).trim();
        const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
        if (m){
          const [_, dd, MM, yyyy, hh='00', mm='00', ss='00'] = m;
          const d = new Date(`${yyyy}-${MM.padStart(2,'0')}-${dd.padStart(2,'0')}T${hh.padStart(2,'0')}:${mm}:${ss}`);
          return isNaN(d) ? null : d.toISOString();
        }
        const d = new Date(str);
        return isNaN(d) ? null : d.toISOString();
      }

      function toBool(s){
        if (s == null) return null;
        const v = String(s).trim().toLowerCase();
        if (["yes","y","true","1"].includes(v)) return true;
        if (["no","n","false","0",""].includes(v)) return false;
        return null;
      }

      function toNum(s){
        if (s == null || s === "") return null;
        const n = Number(String(s).replace(/,/g,""));
        return isNaN(n) ? null : n;
      }

      // Operational day key = LOCAL DATE of (timestamp - 8 hours)
      function opDayKey(ts){
        const d = new Date(ts); // DB ISO -> local instant
        const shifted = new Date(d.getTime() - 8*60*60*1000); // move back 8h
        shifted.setHours(0,0,0,0);
        return ymd(shifted); // local calendar day key
      }

      // Build query window (local â†’ UTC for DB)
      function opDayWindowFor(dateYmd){
        const base = new Date(dateYmd + 'T00:00:00'); // local midnight
        const start = new Date(base); start.setHours(8,0,0,0);  // 08:00 local
        const end = new Date(base); end.setDate(end.getDate()+1); end.setHours(7,59,59,999); // next day 07:59:59.999 local
        return { start, end };
      }

      // PAGINATED FETCH (fix 1000-row cap)
      async function fetchAllPassTxns(startISO, endISO) {
        const pageSize = 1000;  // PostgREST default page size
        let from = 0;
        let all = [];
        let totalCount = null;

        while (true) {
          const { data, error, count } = await supabase
            .from('pass_transactions')
            .select(
              'vehicle_registration_number, mapper_vehicle_class, transaction_processed_time, transaction_amount',
              { count: 'exact' }
            )
            .gte('transaction_processed_time', startISO)
            .lte('transaction_processed_time', endISO)
            .eq('transaction_amount', 15)
            .order('transaction_processed_time', { ascending: true })
            .range(from, from + pageSize - 1);

          if (error) throw error;

          if (totalCount === null && typeof count === 'number') totalCount = count;
          if (data && data.length) all = all.concat(data);

          if (!data || data.length < pageSize) break; // last page
          from += pageSize;
        }

        return { rows: all, count: totalCount ?? all.length };
      }

      // =========================
      // CSV upload with UPSERT (ignore duplicates)
      // =========================
      document.getElementById('btnUpload').onclick = async () => {
        const file = document.getElementById('csvFile').files[0];
        const delim = document.getElementById('csvDelimiter').value;
        const info = document.getElementById('uploadInfo');
        const errBox = document.getElementById('errorBox');
        errBox.textContent = ""; info.textContent = "";

        if(!file){ alert('Choose a CSV file'); return; }

        info.textContent = 'Parsing CSV...';
        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          delimiter: (delim === '\\t' ? '\t' : delim),
          complete: async (res) => {
            const rows = res.data;
            if(!rows.length){ info.textContent = 'No rows found.'; return; }

            if (!('CCH Transaction ID' in rows[0])) {
              info.textContent = 'Missing required header: "CCH Transaction ID".';
              errBox.textContent = 'Ensure your CSV column header exactly matches: CCH Transaction ID';
              return;
            }

            const mapped = rows.map(r => {
              const obj = {};
              for (const [csvKey, dbKey] of Object.entries(HEADER_MAP)) {
                let val = r[csvKey];
                if (dbKey === 'reader_read_time' ||
                    dbKey === 'transaction_received_time' ||
                    dbKey === 'transaction_processed_time' ||
                    dbKey.endsWith('_date')) {
                  val = toISO(val);
                } else if (dbKey === 'chargeback_raised' || dbKey === 'adjustment_raised') {
                  val = toBool(val);
                } else if (['transaction_amount','accepted_amount','chargeback_amount_accepted','adjustment_amount_accepted'].includes(dbKey)) {
                  val = toNum(val);
                } else if (dbKey === 'vehicle_registration_number') {
                  val = (val ?? '').toString().trim().toUpperCase() || null;
                } else {
                  val = (val === '' ? null : val);
                }
                obj[dbKey] = val;
              }
              return obj;
            });

            const chunkSize = 500;
            let ok = 0, failedBatches = 0;
            info.textContent = `Uploading... (0/${mapped.length})`;

            for (let i = 0; i < mapped.length; i += chunkSize) {
              const part = mapped.slice(i, i + chunkSize);

              const { error } = await supabase
                .from('pass_transactions')
                .upsert(part, { onConflict: 'cch_transaction_id', ignoreDuplicates: true });

              if (error) {
                console.error('Supabase upsert error:', error);
                failedBatches++;
                document.getElementById('errorBox').textContent += `Batch ${i/chunkSize + 1}: ${error.message}\n`;
              } else {
                ok += part.length;
              }
              info.textContent = `Uploaded ${ok}/${mapped.length}. ${failedBatches ? 'Failed batches: ' + failedBatches : ''}`;
            }

            if (!failedBatches) {
              info.className = 'success';
              info.textContent += '  âœ“ All good.';
            } else {
              info.className = 'warn';
            }
          },
          error: (e) => {
            info.textContent = 'CSV parse error.';
            document.getElementById('errorBox').textContent = String(e?.message || e);
          }
        });
      };

      // =========================
      // REPORT
      // =========================
      document.getElementById('filterForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const from = document.getElementById('fromDate').value;
        const to = document.getElementById('toDate').value;
        if(!from || !to){ alert('Select dates'); return; }

        // Build UTC window for DB query (correct)
        const { start: globalStart } = opDayWindowFor(from);
        const { end: globalEnd } = opDayWindowFor(to);

        let data, totalCount;
        try {
          const res = await fetchAllPassTxns(globalStart.toISOString(), globalEnd.toISOString());
          data = res.rows;
          totalCount = res.count;
        } catch (error) {
          alert('Fetch failed: ' + error.message);
          return;
        }

        // Group into operational days using LOCAL key (ts - 8h)
        const byOp = new Map();
        for(const r of data){
          const key = opDayKey(r.transaction_processed_time);
          if(!byOp.has(key)) byOp.set(key, []);
          byOp.get(key).push(r);
        }

        // Build labels in LOCAL time for the selected range
        const labels = [];
        {
          const d = new Date(from + 'T00:00:00');  // local midnight
          const toD = new Date(to + 'T00:00:00');  // local midnight
          while(d <= toD){
            labels.push(ymd(d));
            d.setDate(d.getDate()+1);
          }
        }

        const keptRows = [];
        const omittedRows = [];
        const dailyRows = [];

        for (const key of labels) {
          const rows = (byOp.get(key) || []).slice();

          // process in chronological order
          rows.sort((a, b) => new Date(a.transaction_processed_time) - new Date(b.transaction_processed_time));

          const perVeh = new Map();
          let total_txn = rows.length;
          let qualified = 0, singles = 0, returns = 0, omitted = 0;

          const periodStr = `${key}`;

          for (const r of rows) {
            const vrn = (r.vehicle_registration_number || '').toString();
            const now = (perVeh.get(vrn) || 0) + 1;
            perVeh.set(vrn, now);

            if (now <= 2) {
              qualified++;
              const journey = (now % 2 === 1) ? 'Single Journey' : 'Return Journey';
              if (journey === 'Single Journey') singles++; else returns++;
              keptRows.push({
                TransactionProcessedTime: r.transaction_processed_time,
                VehicleRegistrationNumber: r.vehicle_registration_number,
                MapperVehicleClass: r.mapper_vehicle_class,
                TransactionAmount: r.transaction_amount,
                Journey_Type: journey
              });
            } else {
              omitted++;
              omittedRows.push({
                TransactionProcessedTime: r.transaction_processed_time,
                VehicleRegistrationNumber: r.vehicle_registration_number,
                MapperVehicleClass: r.mapper_vehicle_class,
                TransactionAmount: r.transaction_amount,
                txn_no: now
              });
            }
          }

          const comp = singles * SINGLE_FARE + returns * RETURN_FARE;
          dailyRows.push({
            period: periodStr,
            total_txn,
            qualified_txn: qualified,
            total_single: singles,
            total_return: returns,
            compensation: comp,
            omitted
          });
        }

        const tot = {
          period:'TOTAL',
          total_txn: dailyRows.reduce((a,b)=>a+b.total_txn,0),
          qualified_txn: dailyRows.reduce((a,b)=>a+b.qualified_txn,0),
          total_single: dailyRows.reduce((a,b)=>a+b.total_single,0),
          total_return: dailyRows.reduce((a,b)=>a+b.total_return,0),
          compensation: dailyRows.reduce((a,b)=>a+b.compensation,0),
          omitted: dailyRows.reduce((a,b)=>a+b.omitted,0),
        };
        const summary = {
          period: `${from} to ${to}`,
          total_single: tot.total_single,
          single_fare: SINGLE_FARE,
          total_return: tot.total_return,
          return_fare: RETURN_FARE,
          total_comp: tot.compensation,
          omitted: tot.omitted
        };

        // Render summary
        document.getElementById('sum_period').textContent = summary.period;
        document.getElementById('sum_total_single').textContent = summary.total_single;
        document.getElementById('sum_single_fare').textContent = SINGLE_FARE;
        document.getElementById('sum_total_return').textContent = summary.total_return;
        document.getElementById('sum_return_fare').textContent = RETURN_FARE;
        document.getElementById('sum_total_comp').textContent = rupee(summary.total_comp);
        document.getElementById('sum_omitted').textContent = summary.omitted;
        document.getElementById('summaryWrap').style.display = 'block';
        document.getElementById('rowCount').textContent = `Rows considered: ${data.length} of ${totalCount}`;

        // Daily table
        const tb = document.getElementById('dailyTbody');
        tb.innerHTML = dailyRows.map(r=>`
          <tr>
            <td>${r.period}</td>
            <td>${r.total_txn}</td>
            <td>${r.qualified_txn}</td>
            <td>${r.total_single}</td>
            <td>${r.total_return}</td>
            <td>${rupee(r.compensation)}</td>
            <td>${r.omitted}</td>
          </tr>
        `).join('');
        document.getElementById('tot_total_txn').textContent = tot.total_txn;
        document.getElementById('tot_qualified_txn').textContent = tot.qualified_txn;
        document.getElementById('tot_total_single').textContent = tot.total_single;
        document.getElementById('tot_total_return').textContent = tot.total_return;
        document.getElementById('tot_compensation').textContent = rupee(tot.compensation);
        document.getElementById('tot_omitted').textContent = tot.omitted;
        document.getElementById('dailyWrap').style.display = 'block';

        // Kept
        const keptTb = document.getElementById('keptTbody');
        keptTb.innerHTML = keptRows.map(r=>`
          <tr>
            <td>${new Date(r.TransactionProcessedTime).toLocaleString()}</td>
            <td>${r.VehicleRegistrationNumber}</td>
            <td>${r.MapperVehicleClass ?? ''}</td>
            <td>${r.TransactionAmount}</td>
            <td>${r.Journey_Type}</td>
          </tr>
        `).join('');
        document.getElementById('keptWrap').style.display = keptRows.length ? 'block':'none';

        // Omitted
        const omTb = document.getElementById('omitTbody');
        omTb.innerHTML = omittedRows.map(r=>`
          <tr>
            <td>${new Date(r.TransactionProcessedTime).toLocaleString()}</td>
            <td>${r.VehicleRegistrationNumber}</td>
            <td>${r.MapperVehicleClass ?? ''}</td>
            <td>${r.TransactionAmount}</td>
            <td>${r.txn_no}</td>
          </tr>
        `).join('');
        document.getElementById('omitWrap').style.display = omittedRows.length ? 'block':'none';

        // store for export (include everything shown on screen)
        window.__LAST = { summary, dailyRows, tot, keptRows, omittedRows };
      });

      document.getElementById('btnRefresh').onclick = () => {
        const evt = new Event('submit'); document.getElementById('filterForm').dispatchEvent(evt);
      };

      // helper: format a timestamp to "YYYY-MM-DD HH:mm:ss" in LOCAL time
      function fmtLocal(ts) {
        const d = new Date(ts);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const mm = String(d.getMinutes()).padStart(2, '0');
        const ss = String(d.getSeconds()).padStart(2, '0');
        return `${y}-${m}-${day} ${hh}:${mm}:${ss}`;
      }

      // EXCEL export (mirror web view: 4 sheets + wide Period col)
      document.getElementById('btnExportExcel').onclick = () => {
        const L = window.__LAST;
        if(!L){ alert('Run a report first.'); return; }

        const wb = XLSX.utils.book_new();

        // Overall Summary
        const summaryRows = [{
          "Period": L.summary.period,
          "Total Single Journeys": L.summary.total_single,
          "Single Fare (B)": L.summary.single_fare,
          "Total Return Journeys": L.summary.total_return,
          "Return Fare (D)": L.summary.return_fare,
          "Total Compensation": L.summary.total_comp,
          "Omitted Transactions (3rd+)": L.summary.omitted
        }];
        const wsSummary = XLSX.utils.json_to_sheet(summaryRows);
        XLSX.utils.book_append_sheet(wb, wsSummary, 'Overall Summary');

        // Daily Summary (rows + TOTAL)
        const dailyWithTotal = [...L.dailyRows, {
          period: 'TOTAL',
          total_txn: L.tot.total_txn,
          qualified_txn: L.tot.qualified_txn,
          total_single: L.tot.total_single,
          total_return: L.tot.total_return,
          compensation: L.tot.compensation,
          omitted: L.tot.omitted
        }];
        const dailyExport = dailyWithTotal.map(r => ({
          "Period": r.period,
          "Total Annual Pass Transactions": r.total_txn,
          "Total Qualified Transactions": r.qualified_txn,
          "Total Single Journeys": r.total_single,
          "Total Return Journeys": r.total_return,
          "Total Compensation": r.compensation,
          "Omitted Transactions": r.omitted
        }));
        const wsDaily = XLSX.utils.json_to_sheet(dailyExport);
        wsDaily['!cols'] = [{ wch: 40 }]; // widen Period col
        XLSX.utils.book_append_sheet(wb, wsDaily, 'Daily Summary');

        // Kept Transactions
        const keptExport = (L.keptRows || []).map(r => ({
          "Date & Time": fmtLocal(r.TransactionProcessedTime),
          "Vehicle No": r.VehicleRegistrationNumber,
          "Vehicle Type": r.MapperVehicleClass ?? '',
          "Amount": r.TransactionAmount,
          "Journey Type": r.Journey_Type
        }));
        const wsKept = XLSX.utils.json_to_sheet(keptExport);
        XLSX.utils.book_append_sheet(wb, wsKept, 'Kept Transactions');

        // Omitted Transactions
        const omittedExport = (L.omittedRows || []).map(r => ({
          "Date & Time": fmtLocal(r.TransactionProcessedTime),
          "Vehicle No": r.VehicleRegistrationNumber,
          "Vehicle Type": r.MapperVehicleClass ?? '',
          "Amount": r.TransactionAmount,
          "Txn No": r.txn_no
        }));
        const wsOmit = XLSX.utils.json_to_sheet(omittedExport);
        XLSX.utils.book_append_sheet(wb, wsOmit, 'Omitted Transactions');

        XLSX.writeFile(wb, 'summary.xlsx');
      };

      // Print -> PDF
      document.getElementById('btnPrint').onclick = () => window.print();
    </script>
  </div> <!-- /.container -->
</body>
</html>
