<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Annual Pass Transactions - Mundiyar Toll</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .container { max-width: 1200px; margin: 0 auto; }
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; }
    .page-title { color:#333; text-align:center; margin: 0 0 16px 0; }

    h3{ margin-top:28px; }
    .card{ background:#fff;border:1px solid #ddd;border-radius:10px;padding:14px;box-shadow:2px 2px 6px rgba(0,0,0,.08); margin-bottom:16px;}
    label{ display:block; margin:8px 0 6px; color:#444;}
    input,button,select{ padding:8px 10px; border-radius:8px; border:1px solid #aaa; }
    button{ background:#007bff; color:#fff; border:none; cursor:pointer; }
    button:hover{ background:#0056b3; }
    table{ width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; }
    th,td{ padding:10px; border:1px solid #e2e2e2; text-align:left; }
    th{ background:#007bff; color:#fff; }
    tr:nth-child(even){ background:#f9f9f9; }
    .summary { display:flex; flex-wrap:wrap; gap:12px; }
    .box{ border:1px solid #ccc; border-radius:10px; padding:12px; min-width:220px; background:#fff; flex:1; }
    .muted{ color:#666; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .success{ color:#1e7e34; font-weight:600; }
    .warn{ color:#b36b00; font-weight:600; }
    .bad{ color:#b30000; font-weight:600; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    /* Web table: widen "Period" */
    #dailyWrap table th:first-child,
    #dailyWrap table td:first-child {
      width: 420px;
      min-width: 380px;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="page-title">Annual Pass Transactions - Mundiyar Toll</h2>

    <!-- CSV UPLOAD -->
    <div class="card">
      <h3>Upload CSV → <code>pass_transactions</code></h3>
      <div class="row">
        <input type="file" id="csvFile" accept=".csv" />
        <select id="csvDelimiter" title="Choose delimiter">
          <option value=",">Comma</option>
          <option value=";">Semicolon</option>
          <option value="\t">Tab</option>
        </select>
        <button id="btnUpload">Parse & Upload</button>
      </div>
      <div class="row" style="margin-top:8px">
        <span id="uploadInfo" class="muted"></span>
      </div>
      <pre id="errorBox" class="mono" style="white-space:pre-wrap;color:#b30000;margin-top:8px;"></pre>
    </div>

    <!-- REPORT FILTER -->
    <div class="card">
      <h3>Build Report (08:00 → 07:59)</h3>
      <form id="filterForm" class="row">
        <div>
          <label>From Date</label>
          <input type="date" id="fromDate" required />
        </div>
        <div>
          <label>To Date</label>
          <input type="date" id="toDate" required />
        </div>
        <div style="align-self:flex-end">
          <button type="submit">Filter</button>
        </div>
        <div style="align-self:flex-end">
          <button id="btnRefresh" type="button">Refresh</button>
        </div>
      </form>
      <div class="row" style="margin-top:6px">
        <span class="muted">Only transactions with <strong>Transaction Amount = 15</strong> are considered for compensation logic.</span>
      </div>
    </div>

    <!-- SUMMARY -->
    <div id="summaryWrap" class="card" style="display:none">
      <div class="summary">
        <div class="box"><div class="muted">Period</div><div id="sum_period" style="font-weight:700">—</div></div>
        <div class="box"><div class="muted">Total Single Journeys</div><div id="sum_total_single" style="font-weight:700">0</div></div>
        <div class="box"><div class="muted">Single Fare (B)</div><div id="sum_single_fare" style="font-weight:700">110</div></div>
        <div class="box"><div class="muted">Total Return Journeys</div><div id="sum_total_return" style="font-weight:700">0</div></div>
        <div class="box"><div class="muted">Return Fare (D)</div><div id="sum_return_fare" style="font-weight:700">55</div></div>
        <div class="box"><div class="muted">Total Compensation</div><div id="sum_total_comp" style="font-weight:700">0</div></div>
        <div class="box"><div class="muted">Omitted Transactions (3rd+)</div><div id="sum_omitted" style="font-weight:700">0</div></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnExportExcel" style="background:#28a745">Export to Excel</button>
        <button id="btnPrint" style="background:#6c757d">Export to PDF (Print)</button>
        <span id="rowCount" class="muted" style="margin-left:10px"></span>
      </div>
    </div>

    <!-- DAILY -->
    <div id="dailyWrap" class="card" style="display:none">
      <h3>Daily Summary</h3>
      <table id="dailyTable">
        <thead>
          <tr>
            <th>Period</th>
            <th>Total Annual Pass Transactions</th>
            <th>Total Qualified Transactions</th>
            <th>Total Single Journeys</th>
            <th>Total Return Journeys</th>
            <th>Total Compensation</th>
            <th>Omitted Transactions</th>
          </tr>
        </thead>
        <tbody id="dailyTbody"></tbody>
        <tfoot>
          <tr style="background:#ffc107;font-weight:700">
            <td id="tot_period">TOTAL</td>
            <td id="tot_total_txn">0</td>
            <td id="tot_qualified_txn">0</td>
            <td id="tot_total_single">0</td>
            <td id="tot_total_return">0</td>
            <td id="tot_compensation">0</td>
            <td id="tot_omitted">0</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- KEPT -->
    <div id="keptWrap" class="card" style="display:none">
      <h3>Transactions (First 2 per Vehicle in 24hr.)</h3>
      <table id="keptTable">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Vehicle No</th>
            <th>Vehicle Type</th>
            <th>Amount</th>
            <th>Journey Type</th>
          </tr>
        </thead>
        <tbody id="keptTbody"></tbody>
      </table>
    </div>

    <!-- OMITTED -->
    <div id="omitWrap" class="card" style="display:none">
      <h3>Omitted Transactions (3rd and after)</h3>
      <table id="omitTable">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Vehicle No</th>
            <th>Vehicle Type</th>
            <th>Amount</th>
            <th>Txn No</th>
          </tr>
        </thead>
        <tbody id="omitTbody"></tbody>
      </table>
    </div>

    <!-- libs we still use -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
      const log = (...a) => { try { console.log(...a); } catch(_){} };

      // Supabase
      const SUPABASE_URL = "https://pxcbdrkhhoqqhocmrtgj.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4Y2JkcmtoaG9xcWhvY21ydGdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NjIxMDcsImV4cCI6MjA3MjUzODEwN30.ufOrUdyi307pqmZdH5AS56UGmMti8n_2BW8YHK-2rk4";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // fares
      const SINGLE_FARE = 110.0;
      const RETURN_FARE = 55.0;

      const HEADER_MAP = {
        "Entry Plaza ID": "entry_plaza_id",
        "Entry Lane ID": "entry_lane_id",
        "Exit Plaza ID": "exit_plaza_id",
        "Exit Lane ID": "exit_lane_id",
        "Tag ID": "tag_id",
        "Vehicle Registration Number": "vehicle_registration_number",
        "Plaza Transaction ID": "plaza_transaction_id",
        "CCH Transaction ID": "cch_transaction_id",
        "AVC Class": "avc_class",
        "Mapper Vehicle Class": "mapper_vehicle_class",
        "Reader Read Time": "reader_read_time",
        "Transaction Received Time": "transaction_received_time",
        "Transaction Processed Time": "transaction_processed_time",
        "Transaction Amount": "transaction_amount",
        "Accepted Amount": "accepted_amount",
        "Transaction Status": "transaction_status",
        "Reason Code": "reason_code",
        "Fare Type": "fare_type",
        "Chargeback Raised?": "chargeback_raised",
        "Chargeback Amount Accepted": "chargeback_amount_accepted",
        "Chargeback Settlement Date": "chargeback_settlement_date",
        "Adjustment Raised": "adjustment_raised",
        "Adjustment Amount Accepted": "adjustment_amount_accepted",
        "Adjustment Settlement Date": "adjustment_settlement_date",
        "Remarks": "remarks"
      };

      const rupee = n => '₹' + Number(n||0).toLocaleString('en-IN', { maximumFractionDigits: 2 });

      const ymd = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      };

      function toISO(s){
        if (s == null || s === "") return null;
        const str = String(s).trim();
        const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
        if (m){
          const [_, dd, MM, yyyy, hh='00', mm='00', ss='00'] = m;
          const d = new Date(`${yyyy}-${MM.padStart(2,'0')}-${dd.padStart(2,'0')}T${hh.padStart(2,'0')}:${mm}:${ss}`);
          return isNaN(d) ? null : d.toISOString();
        }
        const d = new Date(str);
        return isNaN(d) ? null : d.toISOString();
      }
      function toBool(s){
        if (s == null) return null;
        const v = String(s).trim().toLowerCase();
        if (["yes","y","true","1"].includes(v)) return true;
        if (["no","n","false","0",""].includes(v)) return false;
        return null;
      }
      function toNum(s){
        if (s == null || s === "") return null;
        const n = Number(String(s).replace(/,/g,""));
        return isNaN(n) ? null : n;
      }

      function opDayKey(ts){
        const d = new Date(ts);
        const shifted = new Date(d.getTime() - 8*60*60*1000);
        shifted.setHours(0,0,0,0);
        return ymd(shifted);
      }
      function opDayWindowFor(dateYmd){
        const base = new Date(dateYmd + 'T00:00:00');
        const start = new Date(base); start.setHours(8,0,0,0);
        const end = new Date(base); end.setDate(end.getDate()+1); end.setHours(7,59,59,999);
        return { start, end };
      }

      async function fetchAllPassTxns(startISO, endISO) {
        const pageSize = 1000;
        let from = 0, all = [], totalCount = null;
        while (true) {
          const { data, error, count } = await supabase
            .from('pass_transactions')
            .select(
              'vehicle_registration_number, mapper_vehicle_class, transaction_processed_time, transaction_amount',
              { count: 'exact' }
            )
            .gte('transaction_processed_time', startISO)
            .lte('transaction_processed_time', endISO)
            .eq('transaction_amount', 15)
            .order('transaction_processed_time', { ascending: true })
            .range(from, from + pageSize - 1);

          if (error) throw error;
          if (totalCount === null && typeof count === 'number') totalCount = count;
          if (data && data.length) all = all.concat(data);
          if (!data || data.length < pageSize) break;
          from += pageSize;
        }
        return { rows: all, count: totalCount ?? all.length };
      }

      // CSV → DB
      document.getElementById('btnUpload').onclick = async () => {
        const file = document.getElementById('csvFile').files[0];
        const delim = document.getElementById('csvDelimiter').value;
        const info = document.getElementById('uploadInfo');
        const errBox = document.getElementById('errorBox');
        errBox.textContent = ""; info.textContent = "";
        if(!file){ alert('Choose a CSV file'); return; }

        info.textContent = 'Parsing CSV...';
        Papa.parse(file, {
          header: true, skipEmptyLines: true,
          delimiter: (delim === '\\t' ? '\t' : delim),
          complete: async (res) => {
            const rows = res.data;
            if(!rows.length){ info.textContent = 'No rows found.'; return; }
            if (!('CCH Transaction ID' in rows[0])) {
              info.textContent = 'Missing required header: "CCH Transaction ID".';
              errBox.textContent = 'Ensure your CSV column header exactly matches: CCH Transaction ID';
              return;
            }
            const mapped = rows.map(r => {
              const obj = {};
              for (const [csvKey, dbKey] of Object.entries(HEADER_MAP)) {
                let val = r[csvKey];
                if (dbKey === 'reader_read_time' ||
                    dbKey === 'transaction_received_time' ||
                    dbKey === 'transaction_processed_time' ||
                    dbKey.endsWith('_date')) {
                  val = toISO(val);
                } else if (dbKey === 'chargeback_raised' || dbKey === 'adjustment_raised') {
                  val = toBool(val);
                } else if (['transaction_amount','accepted_amount','chargeback_amount_accepted','adjustment_amount_accepted'].includes(dbKey)) {
                  val = toNum(val);
                } else if (dbKey === 'vehicle_registration_number') {
                  val = (val ?? '').toString().trim().toUpperCase() || null;
                } else {
                  val = (val === '' ? null : val);
                }
                obj[dbKey] = val;
              }
              return obj;
            });

            const chunkSize = 500;
            let ok = 0, failedBatches = 0;
            info.textContent = `Uploading... (0/${mapped.length})`;

            for (let i = 0; i < mapped.length; i += chunkSize) {
              const part = mapped.slice(i, i + chunkSize);
              const { error } = await supabase
                .from('pass_transactions')
                .upsert(part, { onConflict: 'cch_transaction_id', ignoreDuplicates: true });

              if (error) {
                failedBatches++;
                errBox.textContent += `Batch ${i/chunkSize + 1}: ${error.message}\n`;
              } else { ok += part.length; }
              info.textContent = `Uploaded ${ok}/${mapped.length}. ${failedBatches ? 'Failed batches: ' + failedBatches : ''}`;
            }

            info.className = failedBatches ? 'warn' : 'success';
            if (!failedBatches) info.textContent += '  ✓ All good.';
          },
          error: (e) => {
            info.textContent = 'CSV parse error.';
            document.getElementById('errorBox').textContent = String(e?.message || e);
          }
        });
      };

      // REPORT
      document.getElementById('filterForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const from = document.getElementById('fromDate').value;
        const to = document.getElementById('toDate').value;
        if(!from || !to){ alert('Select dates'); return; }

        const { start: globalStart } = opDayWindowFor(from);
        const { end: globalEnd } = opDayWindowFor(to);

        let data, totalCount;
        try {
          const res = await fetchAllPassTxns(globalStart.toISOString(), globalEnd.toISOString());
          data = res.rows; totalCount = res.count;
        } catch (error) { alert('Fetch failed: ' + error.message); return; }

        const byOp = new Map();
        for(const r of data){
          const key = opDayKey(r.transaction_processed_time);
          if(!byOp.has(key)) byOp.set(key, []);
          byOp.get(key).push(r);
        }

        const labels = [];
        { const d = new Date(from + 'T00:00:00');
          const toD = new Date(to + 'T00:00:00');
          while(d <= toD){ labels.push(ymd(d)); d.setDate(d.getDate()+1); }
        }

        const keptRows = [], omittedRows = [], dailyRows = [];
        for (const key of labels) {
          const rows = (byOp.get(key) || []).slice();
          rows.sort((a,b)=> new Date(a.transaction_processed_time) - new Date(b.transaction_processed_time));
          const perVeh = new Map();
          let total_txn = rows.length, qualified = 0, singles = 0, returns = 0, omitted = 0;

          for (const r of rows) {
            const vrn = (r.vehicle_registration_number || '').toString();
            const now = (perVeh.get(vrn) || 0) + 1; perVeh.set(vrn, now);
            if (now <= 2) {
              qualified++;
              const journey = (now % 2 === 1) ? 'Single Journey' : 'Return Journey';
              if (journey === 'Single Journey') singles++; else returns++;
              keptRows.push({
                TransactionProcessedTime: r.transaction_processed_time,
                VehicleRegistrationNumber: r.vehicle_registration_number,
                MapperVehicleClass: r.mapper_vehicle_class,
                TransactionAmount: r.transaction_amount,
                Journey_Type: journey
              });
            } else {
              omitted++;
              omittedRows.push({
                TransactionProcessedTime: r.transaction_processed_time,
                VehicleRegistrationNumber: r.vehicle_registration_number,
                MapperVehicleClass: r.mapper_vehicle_class,
                TransactionAmount: r.transaction_amount,
                txn_no: now
              });
            }
          }

          const comp = singles * SINGLE_FARE + returns * RETURN_FARE;
          dailyRows.push({
            period: key,
            total_txn, qualified_txn: qualified,
            total_single: singles, total_return: returns,
            compensation: comp, omitted
          });
        }

        const tot = {
          period:'TOTAL',
          total_txn: dailyRows.reduce((a,b)=>a+b.total_txn,0),
          qualified_txn: dailyRows.reduce((a,b)=>a+b.qualified_txn,0),
          total_single: dailyRows.reduce((a,b)=>a+b.total_single,0),
          total_return: dailyRows.reduce((a,b)=>a+b.total_return,0),
          compensation: dailyRows.reduce((a,b)=>a+b.compensation,0),
          omitted: dailyRows.reduce((a,b)=>a+b.omitted,0),
        };
        const summary = {
          period: `${from} to ${to}`,
          total_single: tot.total_single,
          single_fare: SINGLE_FARE,
          total_return: tot.total_return,
          return_fare: RETURN_FARE,
          total_comp: tot.compensation,
          omitted: tot.omitted
        };

        // Render summary
        document.getElementById('sum_period').textContent = summary.period;
        document.getElementById('sum_total_single').textContent = summary.total_single;
        document.getElementById('sum_single_fare').textContent = SINGLE_FARE;
        document.getElementById('sum_total_return').textContent = summary.total_return;
        document.getElementById('sum_return_fare').textContent = RETURN_FARE;
        document.getElementById('sum_total_comp').textContent = rupee(summary.total_comp);
        document.getElementById('sum_omitted').textContent = summary.omitted;
        document.getElementById('summaryWrap').style.display = 'block';
        document.getElementById('rowCount').textContent = `Rows considered: ${data.length} of ${totalCount}`;

        // Daily table (web)
        const tb = document.getElementById('dailyTbody');
        tb.innerHTML = dailyRows.map(r=>`
          <tr>
            <td>${r.period}</td>
            <td>${r.total_txn}</td>
            <td>${r.qualified_txn}</td>
            <td>${r.total_single}</td>
            <td>${r.total_return}</td>
            <td>${rupee(r.compensation)}</td>
            <td>${r.omitted}</td>
          </tr>
        `).join('');
        document.getElementById('tot_total_txn').textContent = tot.total_txn;
        document.getElementById('tot_qualified_txn').textContent = tot.qualified_txn;
        document.getElementById('tot_total_single').textContent = tot.total_single;
        document.getElementById('tot_total_return').textContent = tot.total_return;
        document.getElementById('tot_compensation').textContent = rupee(tot.compensation);
        document.getElementById('tot_omitted').textContent = tot.omitted;
        document.getElementById('dailyWrap').style.display = 'block';

        // Kept
        const keptTb = document.getElementById('keptTbody');
        keptTb.innerHTML = keptRows.map(r=>`
          <tr>
            <td>${new Date(r.TransactionProcessedTime).toLocaleString()}</td>
            <td>${r.VehicleRegistrationNumber}</td>
            <td>${r.MapperVehicleClass ?? ''}</td>
            <td>${r.TransactionAmount}</td>
            <td>${r.Journey_Type}</td>
          </tr>
        `).join('');
        document.getElementById('keptWrap').style.display = keptRows.length ? 'block':'none';

        // Omitted
        const omTb = document.getElementById('omitTbody');
        omTb.innerHTML = omittedRows.map(r=>`
          <tr>
            <td>${new Date(r.TransactionProcessedTime).toLocaleString()}</td>
            <td>${r.VehicleRegistrationNumber}</td>
            <td>${r.MapperVehicleClass ?? ''}</td>
            <td>${r.TransactionAmount}</td>
            <td>${r.txn_no}</td>
          </tr>
        `).join('');
        document.getElementById('omitWrap').style.display = omittedRows.length ? 'block':'none';

        // Save for export
        window.__LAST = { summary, dailyRows, tot, keptRows, omittedRows };
      });

      document.getElementById('btnRefresh').onclick = () => {
        const evt = new Event('submit'); document.getElementById('filterForm').dispatchEvent(evt);
      };

      // ===== Excel 2003 XML (.xls) generator (no libs) =====
      function xmlEsc(s){
        return String(s ?? '')
          .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;').replace(/'/g,'&apos;');
      }
      const row = cells => `<Row>${cells}</Row>`;
      const cell = ({v=null,type='String',style=null}) => {
        const styleAttr = style ? ` ss:StyleID="${style}"` : '';
        const val = (v===null || v===undefined) ? '' : v;
        return `<Cell${styleAttr}><Data ss:Type="${type}">${xmlEsc(val)}</Data></Cell>`;
      };

      // Build ONE combined "Summary" sheet (Overall + Daily)
      function buildSummarySheet({summary, dailyRows, tot}) {
        // columns & widths (first column wide for Period area later)
        const widths = [260, 180, 160, 200, 160, 180, 200];

        // ---- Overall Summary section
        const titleOverall = row( cell({ v:'Overall Summary', style:'sTitle' }) );
        const overallHeader = row(
          cell({v:'Period', style:'sHead'}) +
          cell({v:'Total Single Journeys', style:'sHead'}) +
          cell({v:'Single Fare (B)', style:'sHead'}) +
          cell({v:'Total Return Journeys', style:'sHead'}) +
          cell({v:'Return Fare (D)', style:'sHead'}) +
          cell({v:'Total Compensation', style:'sHead'}) +
          cell({v:'Omitted Transactions (3rd+)', style:'sHead'})
        );
        const overallData = row(
          cell({v:summary.period, style:'sTxt'}) +
          cell({v:Number(summary.total_single), type:'Number', style:'sNum'}) +
          cell({v:Number(summary.single_fare), type:'Number', style:'sCur'}) +
          cell({v:Number(summary.total_return), type:'Number', style:'sNum'}) +
          cell({v:Number(summary.return_fare), type:'Number', style:'sCur'}) +
          cell({v:Number(summary.total_comp), type:'Number', style:'sCur'}) +
          cell({v:Number(summary.omitted), type:'Number', style:'sNum'})
        );

        const blank = row( cell({v:''}) );

        // ---- Daily Summary section (with TOTAL row)
        const titleDaily = row( cell({ v:'Daily Summary', style:'sTitle' }) );

        const dailyHeader = row(
          cell({v:'Period', style:'sHead'}) +
          cell({v:'Total Annual Pass Transactions', style:'sHead'}) +
          cell({v:'Total Qualified Transactions', style:'sHead'}) +
          cell({v:'Total Single Journeys', style:'sHead'}) +
          cell({v:'Total Return Journeys', style:'sHead'}) +
          cell({v:'Total Compensation', style:'sHead'}) +
          cell({v:'Omitted Transactions', style:'sHead'})
        );

        const dailyBody = dailyRows.map(r => row(
          cell({v:r.period, style:'sTxt'}) +
          cell({v:Number(r.total_txn), type:'Number', style:'sNum'}) +
          cell({v:Number(r.qualified_txn), type:'Number', style:'sNum'}) +
          cell({v:Number(r.total_single), type:'Number', style:'sNum'}) +
          cell({v:Number(r.total_return), type:'Number', style:'sNum'}) +
          cell({v:Number(r.compensation), type:'Number', style:'sCur'}) +
          cell({v:Number(r.omitted), type:'Number', style:'sNum'})
        )).join('');

        const dailyTotal = row(
          cell({v:'TOTAL', style:'sHead'}) +
          cell({v:Number(tot.total_txn), type:'Number', style:'sNumBold'}) +
          cell({v:Number(tot.qualified_txn), type:'Number', style:'sNumBold'}) +
          cell({v:Number(tot.total_single), type:'Number', style:'sNumBold'}) +
          cell({v:Number(tot.total_return), type:'Number', style:'sNumBold'}) +
          cell({v:Number(tot.compensation), type:'Number', style:'sCurBold'}) +
          cell({v:Number(tot.omitted), type:'Number', style:'sNumBold'})
        );

        const colsXml = widths.map(w => `<Column ss:Width="${w}"/>`).join('');

        return `
          <Worksheet ss:Name="Summary">
            <Table>
              ${colsXml}
              ${titleOverall}
              ${overallHeader}
              ${overallData}
              ${blank}
              ${titleDaily}
              ${dailyHeader}
              ${dailyBody}
              ${dailyTotal}
            </Table>
          </Worksheet>
        `;
      }

      function buildListSheet({name, rows, columns}) {
        const colsXml = columns.map(c => `<Column ss:Width="${c.w || 120}"/>`).join('');
        const header = row(columns.map(c => cell({v:c.h, style:'sHead'})).join(''));
        const body = rows.map(r => row(columns.map(c => {
          const val = typeof c.a === 'function' ? c.a(r) : r[c.a];
          if (c.t === 'n') return cell({v:Number(val ?? 0), type:'Number', style: c.s || 'sNum'});
          if (c.t === 'c') return cell({v:Number(val ?? 0), type:'Number', style: c.s || 'sCur'});
          return cell({v: (val ?? ''), style: c.s || 'sTxt'});
        }).join(''))).join('');
        return `
          <Worksheet ss:Name="${xmlEsc(name)}">
            <Table>
              ${colsXml}
              ${header}
              ${body}
            </Table>
          </Worksheet>
        `;
      }

      function buildWorkbookXml({summary, dailyRows, tot, keptRows, omittedRows}) {
        const styles = `
          <Styles>
            <Style ss:ID="sHead">
              <Font ss:Bold="1"/>
              <Interior ss:Color="#D9E1F2" ss:Pattern="Solid"/>
              <Borders>
                <Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/>
              </Borders>
            </Style>
            <Style ss:ID="sTitle">
              <Font ss:Bold="1" ss:Size="12"/>
            </Style>
            <Style ss:ID="sTxt">
              <Alignment ss:Vertical="Center"/>
            </Style>
            <Style ss:ID="sNum">
              <NumberFormat ss:Format="#,##0"/>
            </Style>
            <Style ss:ID="sNumBold">
              <Font ss:Bold="1"/>
              <NumberFormat ss:Format="#,##0"/>
            </Style>
            <Style ss:ID="sCur">
              <NumberFormat ss:Format="[$₹-400]#,##0.00"/>
            </Style>
            <Style ss:ID="sCurBold">
              <Font ss:Bold="1"/>
              <NumberFormat ss:Format="[$₹-400]#,##0.00"/>
            </Style>
          </Styles>
        `;

        // Kept Transactions sheet
        const keptSheet = buildListSheet({
          name: 'Kept Transactions',
          rows: keptRows || [],
          columns: [
            { h:'Date & Time', a:r=>new Date(r.TransactionProcessedTime).toLocaleString(), t:'s', w:160 },
            { h:'Vehicle No', a:'VehicleRegistrationNumber', t:'s', w:120 },
            { h:'Vehicle Type', a:r=> (r.MapperVehicleClass ?? ''), t:'s', w:120 },
            { h:'Amount', a:'TransactionAmount', t:'c', w:110 },
            { h:'Journey Type', a:'Journey_Type', t:'s', w:120 },
          ]
        });

        // Omitted Transactions sheet
        const omitSheet = buildListSheet({
          name: 'Omitted Transactions',
          rows: omittedRows || [],
          columns: [
            { h:'Date & Time', a:r=>new Date(r.TransactionProcessedTime).toLocaleString(), t:'s', w:160 },
            { h:'Vehicle No', a:'VehicleRegistrationNumber', t:'s', w:120 },
            { h:'Vehicle Type', a:r=> (r.MapperVehicleClass ?? ''), t:'s', w:120 },
            { h:'Amount', a:'TransactionAmount', t:'c', w:110 },
            { h:'Txn No', a:'txn_no', t:'n', w:80 },
          ]
        });

        const xml =
`<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook
  xmlns="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:o="urn:schemas-microsoft-com:office:office"
  xmlns:x="urn:schemas-microsoft-com:office:excel"
  xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
  xmlns:html="http://www.w3.org/TR/REC-html40">
  ${styles}
  ${buildSummarySheet({summary, dailyRows, tot})}
  ${keptSheet}
  ${omitSheet}
</Workbook>`;
        return xml;
      }

      function downloadXls(xmlString, filename='report.xls') {
        const blob = new Blob([xmlString], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // Export → one file, Summary sheet combines Overall + Daily
      document.getElementById('btnExportExcel').onclick = () => {
        const L = window.__LAST;
        if (!L) { alert('Run a report first.'); return; }
        try {
          const xml = buildWorkbookXml(L);
          downloadXls(xml, 'report.xls');
        } catch (e) {
          console.error(e);
          alert('Excel export failed: ' + (e && e.message ? e.message : e));
        }
      };

      // Print -> PDF
      document.getElementById('btnPrint').onclick = () => window.print();
    </script>
  </div>
</body>
</html>
