<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Annual Pass Transactions (Supabase + CSV Upload)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; }
    h2 { color:#333; } h3{ margin-top:28px; }
    .card{ background:#fff;border:1px solid #ddd;border-radius:10px;padding:14px;box-shadow:2px 2px 6px rgba(0,0,0,.08); margin-bottom:16px;}
    label{ display:block; margin:8px 0 6px; color:#444;}
    input,button,select{ padding:8px 10px; border-radius:8px; border:1px solid #aaa; }
    button{ background:#007bff; color:#fff; border:none; cursor:pointer; }
    button:hover{ background:#0056b3; }
    table{ width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; }
    th,td{ padding:10px; border:1px solid #e2e2e2; text-align:left; }
    th{ background:#007bff; color:#fff; }
    tr:nth-child(even){ background:#f9f9f9; }
    .summary { display:flex; flex-wrap:wrap; gap:12px; }
    .box{ border:1px solid #ccc; border-radius:10px; padding:12px; min-width:220px; background:#fff; flex:1; }
    .muted{ color:#666; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .success{ color:#1e7e34; font-weight:600; }
    .warn{ color:#b36b00; font-weight:600; }
    .bad{ color:#b30000; font-weight:600; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <h2>Annual Pass Transactions — Supabase (Free) + CSV Upload</h2>

  <!-- CSV UPLOAD -->
  <div class="card">
    <h3>Upload CSV → Insert rows into <code>pass_transactions</code></h3>
    <p class="muted">
      The uploader accepts your CSV with these headers (any order is fine):<br/>
      <em>
      Entry Plaza ID, Entry Lane ID, Exit Plaza ID, Exit Lane ID, Tag ID,
      Vehicle Registration Number, Plaza Transaction ID, CCH Transaction ID, AVC Class, Mapper Vehicle Class,
      Reader Read Time, Transaction Received Time, Transaction Processed Time, Transaction Amount, Accepted Amount,
      Transaction Status, Reason Code, Fare Type, Chargeback Raised?, Chargeback Amount Accepted, Chargeback Settlement Date,
      Adjustment Raised, Adjustment Amount Accepted, Adjustment Settlement Date, Remarks
      </em>
    </p>
    <div class="row">
      <input type="file" id="csvFile" accept=".csv" />
      <select id="csvDelimiter" title="Choose delimiter">
        <option value=",">Comma</option>
        <option value=";">Semicolon</option>
        <option value="\t">Tab</option>
      </select>
      <button id="btnUpload">Parse & Upload</button>
      <button id="btnCount" type="button" title="Quick test: count rows with amount=15">Test Count</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span id="uploadInfo" class="muted"></span>
    </div>
    <pre id="errorBox" class="mono" style="white-space:pre-wrap;color:#b30000;margin-top:8px;"></pre>
  </div>

  <!-- REPORT FILTER (scaffold) -->
  <div class="card">
    <h3>Build Report (08:00 → next day 07:59)</h3>
    <form id="filterForm" class="row" onsubmit="event.preventDefault(); alert('Reporting logic can be added here.');">
      <div>
        <label>From Date</label>
        <input type="date" id="fromDate" required />
      </div>
      <div>
        <label>To Date</label>
        <input type="date" id="toDate" required />
      </div>
      <div style="align-self:flex-end">
        <button type="submit">Filter</button>
      </div>
    </form>
    <div class="row" style="margin-top:6px">
      <span class="muted">Only transactions with <strong>Transaction Amount = 15</strong> are considered for compensation logic.</span>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // 🔗 Supabase credentials (auto-connect)
    const SUPABASE_URL = "https://pxcbdrkhhoqqhocmrtgj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB4Y2JkcmtoaG9xcWhvY21ydGdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NjIxMDcsImV4cCI6MjA3MjUzODEwN30.ufOrUdyi307pqmZdH5AS56UGmMti8n_2BW8YHK-2rk4";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ✅ CSV header mapping -> DB columns (snake_case)
    const HEADER_MAP = {
      "Entry Plaza ID": "entry_plaza_id",
      "Entry Lane ID": "entry_lane_id",
      "Exit Plaza ID": "exit_plaza_id",
      "Exit Lane ID": "exit_lane_id",
      "Tag ID": "tag_id",
      "Vehicle Registration Number": "vehicle_registration_number",
      "Plaza Transaction ID": "plaza_transaction_id",
      "CCH Transaction ID": "cch_transaction_id",   // UNIQUE constraint / onConflict
      "AVC Class": "avc_class",
      "Mapper Vehicle Class": "mapper_vehicle_class",
      "Reader Read Time": "reader_read_time",             // timestamptz
      "Transaction Received Time": "transaction_received_time", // timestamptz
      "Transaction Processed Time": "transaction_processed_time", // timestamptz
      "Transaction Amount": "transaction_amount",         // numeric
      "Accepted Amount": "accepted_amount",               // numeric
      "Transaction Status": "transaction_status",
      "Reason Code": "reason_code",
      "Fare Type": "fare_type",
      "Chargeback Raised?": "chargeback_raised",          // boolean
      "Chargeback Amount Accepted": "chargeback_amount_accepted", // numeric
      "Chargeback Settlement Date": "chargeback_settlement_date", // timestamptz
      "Adjustment Raised": "adjustment_raised",           // boolean
      "Adjustment Amount Accepted": "adjustment_amount_accepted", // numeric
      "Adjustment Settlement Date": "adjustment_settlement_date", // timestamptz
      "Remarks": "remarks"
    };

    // 🔧 Helpers: date, boolean, number normalization
    function toISO(s){
      if (s == null || s === "") return null;
      const str = String(s).trim();

      // Handle DD/MM/YYYY HH:mm[:ss]
      const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
      if (m){
        const [_, dd, MM, yyyy, hh='00', mm='00', ss='00'] = m;
        const d = new Date(`${yyyy}-${MM.padStart(2,'0')}-${dd.padStart(2,'0')}T${hh.padStart(2,'0')}:${mm}:${ss}`);
        return isNaN(d) ? null : d.toISOString();
      }

      // Try native parse
      const d = new Date(str);
      return isNaN(d) ? null : d.toISOString();
    }

    function toBool(s){
      if (s == null) return null;
      const v = String(s).trim().toLowerCase();
      if (["yes","y","true","1"].includes(v)) return true;
      if (["no","n","false","0",""].includes(v)) return false;
      return null;
    }

    function toNum(s){
      if (s == null || s === "") return null;
      const n = Number(String(s).replace(/,/g,""));
      return isNaN(n) ? null : n;
    }

    // 🟢 CSV upload with UPSERT on cch_transaction_id
    document.getElementById('btnUpload').onclick = async () => {
      const file = document.getElementById('csvFile').files[0];
      const delim = document.getElementById('csvDelimiter').value;
      const info = document.getElementById('uploadInfo');
      const errBox = document.getElementById('errorBox');
      errBox.textContent = "";
      info.textContent = "";

      if(!file){ alert('Choose a CSV file'); return; }

      info.textContent = 'Parsing CSV...';
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        delimiter: (delim === '\\t' ? '\t' : delim),
        complete: async (res) => {
          const rows = res.data;
          if(!rows.length){ info.textContent = 'No rows found.'; return; }

          // Validate required key
          if (!('CCH Transaction ID' in rows[0])) {
            info.textContent = 'Missing required header: "CCH Transaction ID".';
            errBox.textContent = 'Ensure your CSV column header exactly matches: CCH Transaction ID';
            return;
          }

          // Map & normalize types
          const mapped = rows.map((r, idx) => {
            const obj = {};
            for (const [csvKey, dbKey] of Object.entries(HEADER_MAP)) {
              let val = r[csvKey];
              if (dbKey === 'reader_read_time' ||
                  dbKey === 'transaction_received_time' ||
                  dbKey === 'transaction_processed_time' ||
                  dbKey.endsWith('_date')) {
                val = toISO(val);
              } else if (dbKey === 'chargeback_raised' || dbKey === 'adjustment_raised') {
                val = toBool(val);
              } else if (['transaction_amount','accepted_amount','chargeback_amount_accepted','adjustment_amount_accepted'].includes(dbKey)) {
                val = toNum(val);
              } else if (dbKey === 'vehicle_registration_number') {
                val = (val ?? '').toString().trim().toUpperCase() || null;
              } else {
                // plain text
                val = (val === '' ? null : val);
              }
              obj[dbKey] = val;
            }
            return obj;
          });

          // Chunked upsert
          const chunkSize = 500;
          let ok = 0, failedBatches = 0;
          info.textContent = `Uploading... (0/${mapped.length})`;

          for (let i = 0; i < mapped.length; i += chunkSize) {
            const part = mapped.slice(i, i + chunkSize);

            const { error } = await supabase
              .from('pass_transactions')
              .upsert(part, { onConflict: 'cch_transaction_id' }); // ← v2 expects a string here

            if (error) {
              console.error('Supabase upsert error:', error);
              failedBatches++;
              errBox.textContent += `Batch ${i/chunkSize + 1}: ${error.message}\n`;
            } else {
              ok += part.length;
            }
            info.textContent = `Uploaded ${ok}/${mapped.length}. ${failedBatches ? 'Failed batches: ' + failedBatches : ''}`;
          }

          if (!failedBatches) {
            info.className = 'success';
            info.textContent += '  ✓ All good.';
          } else {
            info.className = 'warn';
          }
        },
        error: (e) => {
          info.textContent = 'CSV parse error.';
          errBox.textContent = String(e?.message || e);
        }
      });
    };

    // 🔎 Quick sanity check button: count rows with Transaction Amount = 15
    document.getElementById('btnCount').onclick = async () => {
      const { data, error } = await supabase
        .from('pass_transactions')
        .select('cch_transaction_id', { count: 'exact', head: true })
        .eq('transaction_amount', 15);

      const info = document.getElementById('uploadInfo');
      const errBox = document.getElementById('errorBox');
      if (error) {
        errBox.textContent = 'Count failed: ' + error.message;
      } else {
        info.textContent = `Rows with Transaction Amount = 15: ${data?.length ?? 0} (count shows in network headers, open DevTools > Network if needed)`;
      }
    };
  </script>
</body>
</html>
